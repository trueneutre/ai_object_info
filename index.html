<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <!-- Data URL 파비콘 (별도 파일 불필요) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%233B82F6' rx='4'/%3E%3Ccircle cx='16' cy='12' r='4' fill='white' stroke='%231E40AF' stroke-width='1'/%3E%3Crect x='12' y='18' width='8' height='6' fill='white' rx='1'/%3E%3Ccircle cx='14' cy='20' r='0.5' fill='%233B82F6'/%3E%3Ccircle cx='18' cy='20' r='0.5' fill='%233B82F6'/%3E%3Crect x='15' y='21.5' width='2' height='1' fill='%233B82F6' rx='0.5'/%3E%3C/svg%3E"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="theme-color" content="#3B82F6"/>
    <meta name="description" content="AI 카메라로 사물을 분석하는 웹앱"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
    <meta name="apple-mobile-web-app-title" content="사물 인식기"/>
    <!-- Data URL 아이콘 (별도 파일 불필요) -->
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFjklEQVR4nO3dS3LiQBCFYbGBmZk1s4FZ83/YwAZmZtbMBmaGCxAGlZ5PqrqU3/fFDXaXSl35SirJT8/Pz88fxpj/+vHjx4+Pj49/fXx8/Pr29vbfnz9//v39/f2P7+/vf/z69esf7+/vf3p9fX1+eXl5fn5+fn56enp6fHx8fHh4eHh/f394e3t7u7+/v7u7u7u9vb29ubm5ubm+vr65urq6vry8vLy4uLi4ODk5OT45OTk+Pj4+Pjo6Oj46Ojo6PDw8PDg4ODg/Pz8/Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O"/>
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22%EC%82%AC%EB%AC%BC%EC%9D%B8%EC%8B%9D%EA%B8%B0%22%2C%22short_name%22%3A%22%EC%82%AC%EB%AC%BC%EC%9D%B8%EC%8B%9D%EA%B8%B0%22%2C%22start_url%22%3A%22./%22%2C%22display%22%3A%22standalone%22%2C%22theme_color%22%3A%22%233B82F6%22%2C%22background_color%22%3A%22%23EFF6FF%22%2C%22orientation%22%3A%22portrait-primary%22%2C%22scope%22%3A%22./%22%7D"/>
    <title>사물 인식기 - AI 카메라 분석</title>
    
    <!-- 외부 라이브러리 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}
        #root{min-height:100vh}
        .loading{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#eff6ff 0%,#e0e7ff 100%)}
        .spinner{animation:spin 1s linear infinite;border:3px solid #e5e7eb;border-radius:50%;border-top:3px solid #3b82f6;height:2rem;width:2rem}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        @media (prefers-reduced-motion:reduce){.spinner{animation:none}}
        
        /* Touch optimizations */
        body{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        button{-webkit-appearance:none;-moz-appearance:none;appearance:none}
        video{object-fit:cover;width:100%}
        
        /* Backdrop blur fallback */
        .backdrop-blur{backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
        .bg-white\/90{background-color:rgba(255,255,255,0.9)}
    </style>
</head>
<body>
    <noscript>JavaScript를 활성화해야 이 앱을 사용할 수 있습니다.</noscript>
    <div id="root">
        <div class="loading">
            <div>
                <div class="spinner"></div>
                <p style="margin-top:1rem;color:#6b7280">앱 로딩 중...</p>
            </div>
        </div>
    </div>

    <script>
        // Object Analyzer Component
        function ObjectAnalyzer() {
            const useState = React.useState;
            const useRef = React.useRef;
            const useCallback = React.useCallback;
            const useEffect = React.useEffect;
            const createElement = React.createElement;
            
            const [apiKey, setApiKey] = useState('AIzaSyBN0xDSTxUat1bKoaULcQP81ZowswKBIPI');
            const [showApiInput, setShowApiInput] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [error, setError] = useState('');
            const [stream, setStream] = useState(null);
            const [isCameraOn, setIsCameraOn] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            // Online/offline detection
            useEffect(function() {
                function handleOnline() { setIsOnline(true); }
                function handleOffline() { setIsOnline(false); }
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return function() {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            const startCamera = useCallback(async function() {
                try {
                    if (!navigator.mediaDevices) {
                        alert('❌ 이 브라우저는 카메라를 지원하지 않습니다!\\n\\nChrome이나 Safari 최신 버전을 사용해주세요.');
                        return;
                    }
                    
                    if (!navigator.mediaDevices.getUserMedia) {
                        alert('❌ 이 브라우저는 카메라 접근을 지원하지 않습니다!\\n\\n최신 브라우저로 업데이트해주세요.');
                        return;
                    }

                    console.log('카메라 요청 시작...');
                    
                    try {
                        const mediaStream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: 'environment',
                                width: { ideal: 1920, max: 1920 },
                                height: { ideal: 1080, max: 1080 }
                            } 
                        });
                        
                        console.log('카메라 스트림 획득 성공');
                        
                        if (videoRef.current) {
                            videoRef.current.srcObject = mediaStream;
                            setStream(mediaStream);
                            setIsCameraOn(true);
                            console.log('카메라 활성화 완료');
                        }
                    } catch (highResError) {
                        if (highResError.name === 'OverconstrainedError') {
                            // Fallback to lower resolution
                            const mediaStream = await navigator.mediaDevices.getUserMedia({ 
                                video: { 
                                    facingMode: 'environment',
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                } 
                            });
                            
                            if (videoRef.current) {
                                videoRef.current.srcObject = mediaStream;
                                setStream(mediaStream);
                                setIsCameraOn(true);
                            }
                        } else {
                            throw highResError;
                        }
                    }
                } catch (err) {
                    console.error('카메라 오류:', err);
                    
                    let alertMessage = '';
                    
                    if (err.name === 'NotAllowedError') {
                        alertMessage = '📱 카메라 접근이 차단되었습니다!\\n\\n해결 방법:\\n1. 브라우저 주소창의 카메라 아이콘 클릭\\n2. "허용" 선택\\n3. 페이지 새로고침 후 다시 시도';
                    } else if (err.name === 'NotFoundError') {
                        alertMessage = '📷 카메라를 찾을 수 없습니다!\\n\\n다른 앱에서 카메라를 사용 중인지 확인해주세요.';
                    } else if (err.name === 'NotSupportedError' || err.name === 'NotReadableError') {
                        alertMessage = '🔒 카메라를 사용할 수 없습니다!\\n\\n브라우저를 최신 버전으로 업데이트해보세요.';
                    } else {
                        alertMessage = '❌ 카메라 연결 실패!\\n\\n오류: ' + (err.message || '알 수 없는 오류') + '\\n\\n해결 방법:\\n1. 페이지 새로고침\\n2. 브라우저 완전 종료 후 재시작';
                    }
                    
                    alert(alertMessage);
                }
            }, []);

            const stopCamera = useCallback(function() {
                if (stream) {
                    stream.getTracks().forEach(function(track) {
                        track.stop();
                    });
                    setStream(null);
                    setIsCameraOn(false);
                }
            }, [stream]);

            const captureImage = useCallback(function() {
                if (!videoRef.current || !canvasRef.current) return;
                
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                context.drawImage(video, 0, 0);
                
                const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                setCapturedImage(imageDataUrl);
                stopCamera();
                setAnalysisResult(null);
            }, [stopCamera]);

            const analyzeImage = async function() {
                if (!isOnline) {
                    setError('🌐 인터넷 연결을 확인해주세요. 오프라인 상태에서는 분석할 수 없습니다.');
                    return;
                }

                if (!capturedImage) {
                    alert('❌ 먼저 사물을 촬영해주세요!');
                    return;
                }
                
                if (!apiKey.trim()) {
                    setError('🔑 Google Gemini API 키를 설정해주세요.\\n\\n상단의 설정(⚙️) 버튼을 클릭하여 API 키를 입력하세요.');
                    return;
                }

                setIsAnalyzing(true);
                setError('');
                
                try {
                    const base64Image = capturedImage.split(',')[1];
                    
                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + apiKey, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    {
                                        text: '이 이미지의 사물을 자세히 분석해서 다음 형식의 JSON으로 응답해주세요. 다른 텍스트 없이 JSON만 응답해주세요:\\n\\n{\\n  "name": "사물의 정확한 이름",\\n  "category": "카테고리",\\n  "colors": ["주요 색상1", "주요 색상2", "보조 색상"],\\n  "material": "재질/소재 (구체적으로)",\\n  "texture": "질감에 대한 상세한 설명",\\n  "estimatedSize": "크기 추정 (구체적인 치수나 비교)",\\n  "characteristics": ["특징1", "특징2", "특징3", "특징4"],\\n  "usage": "용도 또는 사용법 (상세히)",\\n  "additionalInfo": "흥미로운 정보나 역사, 제조사 등"\\n}'
                                    },
                                    {
                                        inline_data: {
                                            mime_type: "image/jpeg",
                                            data: base64Image
                                        }
                                    }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 400) {
                            throw new Error('❌ 잘못된 API 키입니다. API 키를 확인해주세요.');
                        } else if (response.status === 429) {
                            throw new Error('⏳ API 호출 한도를 초과했습니다. 잠시 후 다시 시도해주세요.');
                        } else if (response.status === 403) {
                            throw new Error('🚫 API 키에 Gemini 사용 권한이 없습니다. Google AI Studio에서 권한을 확인해주세요.');
                        } else {
                            throw new Error('🌐 API 오류가 발생했습니다. (오류 코드: ' + response.status + ')');
                        }
                    }

                    const data = await response.json();
                    
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        throw new Error('🤖 AI가 이미지를 분석할 수 없습니다. 더 명확한 사물 사진을 촬영해보세요.');
                    }
                    
                    const analysisText = data.candidates[0].content.parts[0].text;
                    
                    const cleanedText = analysisText.replace(/```json\\n?|```\\n?/g, '').trim();
                    const analysis = JSON.parse(cleanedText);
                    
                    setAnalysisResult(analysis);
                } catch (err) {
                    console.error('분석 오류:', err);
                    
                    if (err.message.startsWith('❌') || err.message.startsWith('⏳') || err.message.startsWith('🚫') || err.message.startsWith('🌐') || err.message.startsWith('🤖')) {
                        setError(err.message);
                    } else if (err.name === 'SyntaxError') {
                        setError('🔧 AI 응답을 처리하는 중 오류가 발생했습니다. 다시 시도해보세요.');
                    } else if (err.name === 'TypeError' && err.message.includes('fetch')) {
                        setError('🌐 네트워크 오류가 발생했습니다. 인터넷 연결을 확인하고 다시 시도해주세요.');
                    } else {
                        setError('❌ 분석 중 오류가 발생했습니다. 인터넷 연결과 API 키를 확인해주세요.');
                    }
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const resetApp = function() {
                setCapturedImage(null);
                setAnalysisResult(null);
                setError('');
            };

            const InfoCard = function(props) {
                const icon = props.icon;
                const title = props.title;
                const content = props.content;
                
                return createElement('div', {className: "bg-gray-50 rounded-lg p-3 flex items-start hover:bg-gray-100 transition-colors"},
                    createElement('span', {className: "text-xl mr-3 flex-shrink-0"}, icon),
                    createElement('div', {className: "flex-1"},
                        createElement('h3', {className: "font-semibold text-gray-800 mb-1"}, title),
                        createElement('p', {className: "text-gray-600 text-sm leading-relaxed"}, content || '정보 없음')
                    )
                );
            };

            return createElement('div', {className: "min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4"},
                createElement('div', {className: "max-w-md mx-auto"},
                    // Header
                    createElement('div', {className: "flex items-center justify-between mb-6"},
                        createElement('div', {},
                            createElement('h1', {className: "text-2xl font-bold text-gray-800"}, "사물 인식기"),
                            createElement('p', {className: "text-sm text-gray-600 flex items-center mt-1"},
                                createElement(isOnline ? lucide.Wifi : lucide.WifiOff, {className: "w-4 h-4 mr-1 " + (isOnline ? 'text-green-500' : 'text-red-500')}),
                                isOnline ? '온라인' : '오프라인'
                            )
                        ),
                        createElement('button', {
                            onClick: function() { setShowApiInput(!showApiInput); },
                            className: "p-2 bg-white rounded-full shadow-md hover:shadow-lg transition-shadow"
                        }, createElement(lucide.Settings, {className: "w-5 h-5 text-gray-600"}))
                    ),

                    // API Key Input
                    showApiInput && createElement('div', {className: "bg-white rounded-lg p-4 mb-4 shadow-md"},
                        createElement('label', {className: "block text-sm font-medium text-gray-700 mb-2"}, "Google Gemini API 키"),
                        createElement('input', {
                            type: "password",
                            value: apiKey,
                            onChange: function(e) { setApiKey(e.target.value); },
                            placeholder: "API 키를 입력하세요",
                            className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        }),
                        createElement('button', {
                            onClick: function() { setShowApiInput(false); },
                            className: "mt-2 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors"
                        }, "저장")
                    ),

                    // Error Message
                    error && createElement('div', {className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 flex items-start"},
                        createElement(lucide.AlertCircle, {className: "w-5 h-5 mr-2 flex-shrink-0 mt-0.5"}),
                        createElement('div', {className: "whitespace-pre-line text-sm"}, error)
                    ),

                    // Main Content
                    createElement('div', {className: "bg-white rounded-2xl shadow-lg overflow-hidden"},
                        
                        // Camera Area
                        !capturedImage && createElement('div', {className: "relative"},
                            isCameraOn ? createElement('div', {className: "relative"},
                                createElement('video', {
                                    ref: videoRef,
                                    autoPlay: true,
                                    playsInline: true,
                                    muted: true,
                                    className: "w-full h-80 object-cover"
                                }),
                                createElement('div', {className: "absolute inset-0 border-2 border-dashed border-white/50 m-4 rounded-lg"}),
                                createElement('button', {
                                    onClick: captureImage,
                                    className: "absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white text-blue-600 p-4 rounded-full shadow-lg hover:bg-blue-50 transition-colors active:scale-95"
                                }, createElement(lucide.Camera, {className: "w-6 h-6"}))
                            ) : createElement('div', {className: "h-80 flex flex-col items-center justify-center bg-gradient-to-b from-gray-50 to-gray-100"},
                                createElement(lucide.Camera, {className: "w-16 h-16 text-gray-400 mb-4"}),
                                createElement('p', {className: "text-gray-600 mb-6 text-center px-4 font-medium"}, "사물을 촬영하여 AI가 분석해드립니다"),
                                createElement('button', {
                                    onClick: startCamera,
                                    className: "bg-blue-500 text-white px-8 py-4 rounded-xl hover:bg-blue-600 transition-all shadow-md hover:shadow-lg active:scale-95 flex items-center text-lg font-semibold"
                                }, 
                                    createElement(lucide.Camera, {className: "w-6 h-6 mr-3"}),
                                    "촬영하기"
                                )
                            )
                        ),

                        // Captured Image
                        capturedImage && createElement('div', {className: "relative"},
                            createElement('img', {src: capturedImage, alt: "촬영된 이미지", className: "w-full h-80 object-cover"}),
                            createElement('div', {className: "absolute top-2 right-2 flex gap-2"},
                                createElement('button', {
                                    onClick: resetApp,
                                    className: "bg-white/90 backdrop-blur text-gray-600 p-2 rounded-full shadow-md hover:bg-white transition-all"
                                }, createElement(lucide.RotateCcw, {className: "w-4 h-4"}))
                            )
                        ),

                        // Analysis Button
                        capturedImage && !analysisResult && createElement('div', {className: "p-6"},
                            createElement('button', {
                                onClick: analyzeImage,
                                disabled: isAnalyzing || !apiKey.trim() || !isOnline,
                                className: "w-full bg-green-500 text-white py-4 rounded-xl hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg flex items-center justify-center text-lg font-semibold"
                            },
                                isAnalyzing ? [
                                    createElement('div', {key: "spinner", className: "animate-spin rounded-full h-6 w-6 border-b-2 border-white mr-3"}),
                                    "AI 분석 중..."
                                ] : [
                                    createElement(lucide.Search, {key: "icon", className: "w-6 h-6 mr-3"}),
                                    "AI로 분석하기"
                                ]
                            ),
                            (!apiKey.trim() || !isOnline) && createElement('p', {className: "text-sm text-center mt-3 text-orange-600 bg-orange-50 p-2 rounded"}, 
                                !isOnline ? "⚠️ 인터넷 연결이 필요합니다" : "⚠️ API 키가 필요합니다"
                            )
                        ),

                        // Analysis Result
                        analysisResult && createElement('div', {className: "p-6 space-y-4"},
                            createElement('div', {className: "flex items-center text-green-600 mb-6"},
                                createElement(lucide.CheckCircle, {className: "w-6 h-6 mr-2"}),
                                createElement('span', {className: "font-semibold text-lg"}, "AI 분석 완료!")
                            ),

                            // Object Name
                            createElement('div', {className: "text-center mb-6 p-4 bg-blue-50 rounded-xl"},
                                createElement('h2', {className: "text-2xl font-bold text-gray-800 mb-2"}, analysisResult.name),
                                createElement('p', {className: "text-blue-600 font-medium"}, analysisResult.category)
                            ),

                            // Info Cards
                            createElement('div', {className: "space-y-3"},
                                createElement(InfoCard, {icon: "🎨", title: "색상", content: analysisResult.colors && analysisResult.colors.join(', ')}),
                                createElement(InfoCard, {icon: "🧱", title: "재질", content: analysisResult.material}),
                                createElement(InfoCard, {icon: "🤚", title: "질감", content: analysisResult.texture}),
                                createElement(InfoCard, {icon: "📏", title: "예상 크기", content: analysisResult.estimatedSize}),
                                createElement(InfoCard, {icon: "✨", title: "특징", content: analysisResult.characteristics && analysisResult.characteristics.join(', ')}),
                                createElement(InfoCard, {icon: "🔧", title: "용도", content: analysisResult.usage}),
                                analysisResult.additionalInfo && createElement(InfoCard, {icon: "ℹ️", title: "추가 정보", content: analysisResult.additionalInfo})
                            ),

                            createElement('button', {
                                onClick: resetApp,
                                className: "w-full mt-8 bg-blue-500 text-white py-4 rounded-xl hover:bg-blue-600 transition-all shadow-md font-semibold text-lg"
                            }, "새로운 사진 촬영")
                        )
                    ),

                    // Hidden Canvas
                    createElement('canvas', {ref: canvasRef, style: {display: 'none'}})
                )
            );
        }

        // Render the app
        ReactDOM.render(React.createElement(ObjectAnalyzer), document.getElementById('root'));
    </script>
</body>
</html>